// ═══════════════════════════════════════════════════════════════════
// GPS Mock Location Backend - Prisma Schema
// PostgreSQL database schema with all entities
// ═══════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────
// Users Table
// ─────────────────────────────────────────────────────────────────
model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  role         String   @default("user")
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Relations
  devices      Device[]
  routes       Route[]
  auditLogs    AuditLog[]

  @@map("users")
}

// ─────────────────────────────────────────────────────────────────
// Devices Table
// ─────────────────────────────────────────────────────────────────
model Device {
  id           String    @id @default(uuid())
  deviceId     String    @unique @map("device_id")
  userId       String    @map("user_id")
  platform     String    @default("android")
  appVersion   String    @default("1.0.0") @map("app_version")
  registeredAt DateTime  @default(now()) @map("registered_at")
  lastSeenAt   DateTime  @default(now()) @map("last_seen_at")
  isConnected  Boolean   @default(false) @map("is_connected")
  lastIp       String?   @map("last_ip")
  label        String?   // Human-readable name set during enrollment
  
  // Relations
  user         User      @relation(fields: [userId], references: [id])
  streams      Stream[]
  auditLogs    AuditLog[]
  assignedRoute Route?   @relation("DeviceAssignedRoute", fields: [assignedRouteId], references: [id], onDelete: SetNull)
  assignedRouteId String? @map("assigned_route_id")

  // Auth
  credentials  DeviceCredential[]

  @@map("devices")
}

// ─────────────────────────────────────────────────────────────────
// Device Credentials Table
// Stores hashed tokens and enrollment codes
// ─────────────────────────────────────────────────────────────────
model DeviceCredential {
  id           String    @id @default(uuid())
  deviceId     String    @map("device_id")
  type         String    // "ENROLLMENT" | "ACCESS_TOKEN"
  tokenHash    String    @map("token_hash")
  createdAt    DateTime  @default(now()) @map("created_at")
  expiresAt    DateTime? @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")

  device       Device    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)

  @@map("device_credentials")
  @@index([deviceId, type])
}

// ─────────────────────────────────────────────────────────────────
// Routes Table
// ─────────────────────────────────────────────────────────────────
model Route {
  id         String       @id @default(uuid())
  userId     String       @map("user_id")
  name       String?
  sourceType String       @default("points") @map("source_type")
  config     Json?
  createdAt  DateTime     @default(now()) @map("created_at")
  
  // Relations
  user       User         @relation(fields: [userId], references: [id])
  points     RoutePoint[]
  waypoints  RouteWaypoint[]
  streams    Stream[]
  assignedDevices Device[]  @relation("DeviceAssignedRoute")

  @@map("routes")
}

// ─────────────────────────────────────────────────────────────────
// Route Points Table
// ─────────────────────────────────────────────────────────────────
model RoutePoint {
  id           String  @id @default(uuid())
  routeId      String  @map("route_id")
  seq          Int
  lat          Float
  lng          Float
  speed        Float?
  bearing      Float?
  accuracy     Float?
  dwellSeconds Int     @default(0) @map("dwell_seconds")
  
  // Relations
  route    Route   @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@map("route_points")
  @@index([routeId, seq])
}

// ─────────────────────────────────────────────────────────────────
// Route Waypoints Table
// Stores named stops with dwell times for a route
// ─────────────────────────────────────────────────────────────────
model RouteWaypoint {
  id           String  @id @default(uuid())
  routeId      String  @map("route_id")
  seq          Int
  kind         String  // "origin" | "stop" | "destination"
  mode         String  // "address" | "manual"
  label        String?
  text         String?
  lat          Float
  lng          Float
  dwellSeconds Int     @default(0) @map("dwell_seconds")
  pointIndex   Int     @default(0) @map("point_index") // index into route_points for dwell lookup

  // Relations
  route        Route   @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@map("route_waypoints")
  @@index([routeId, seq])
}

// ─────────────────────────────────────────────────────────────────
// Streams Table (Historical)
// ─────────────────────────────────────────────────────────────────
model Stream {
  id        String    @id @default(uuid())
  deviceId  String    @map("device_id")
  routeId   String    @map("route_id")
  status    String    @default("STARTED")  // STARTED, PAUSED, STOPPED
  speed     Float     @default(30)
  loop      Boolean   @default(false)
  startedAt DateTime  @default(now()) @map("started_at")
  stoppedAt DateTime? @map("stopped_at")
  
  // Relations
  device    Device    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  route     Route     @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@map("streams")
  @@index([deviceId, status])
}

// ─────────────────────────────────────────────────────────────────
// Audit Logs Table
// ─────────────────────────────────────────────────────────────────
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  deviceId  String?  @map("device_id")
  action    String
  meta      Json?
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  device    Device?  @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)

  @@map("audit_logs")
  @@index([action, createdAt])
}
